<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Flappy Bird — Telegram Required</title>
<style>
  :root{
    --bg-1:#70c5ce;
    --bg-2:#a7e7ef;
    --btn:#ff8c00;
    --btn-text:#fff;
  }
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));}
  .wrap{width:420px;margin:18px auto;position:relative}
  canvas{display:block;width:100%;height:auto;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.15);background:transparent}
  #score{position:absolute;left:50%;transform:translateX(-50%);top:8px;font-weight:700;color:#000;text-shadow:0 1px 0 #fff}
  /* centered buttons/modals */
  .center-btn{position:absolute;left:50%;transform:translateX(-50%);padding:12px 22px;border-radius:10px;border:0;background:var(--btn);color:var(--btn-text);font-size:18px;cursor:pointer;box-shadow:0 6px 0 rgba(0,0,0,0.12)}
  #startBtn{top:50%}
  #restartBtn{top:50%;display:none}
  #joinModal{position:absolute;inset:40px;border-radius:10px;background:rgba(255,255,255,0.95);display:none;flex-direction:column;align-items:center;justify-content:center;padding:18px;box-shadow:0 12px 30px rgba(0,0,0,0.2)}
  #joinModal a{color:#0066cc;text-decoration:none;font-weight:700;margin-bottom:10px}
  #hint{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;color:rgba(0,0,0,0.6)}
  @media (max-width:480px){
    .wrap{width:94%;margin:12px auto}
  }
</style>
</head>
<body>
  <div class="wrap">
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <div id="score">Điểm: 0</div>

    <!-- Join modal (show when not joined) -->
    <div id="joinModal">
      <h3>Tham gia nhóm Telegram để chơi</h3>
      <a id="openTelegram" href="https://t.me/htuanpremium0" target="_blank" rel="noreferrer">Mở nhóm Telegram</a>
      <button id="iJoined" class="center-btn" style="position:static;padding:10px 18px;margin-top:6px;">Tôi đã tham gia</button>
      <small style="margin-top:8px;color:#444">Sau khi tham gia, bấm "Tôi đã tham gia" để bắt đầu.</small>
    </div>

    <!-- Buttons centered -->
    <button id="startBtn" class="center-btn">Bắt đầu</button>
    <button id="restartBtn" class="center-btn">Chơi lại</button>

    <div id="hint">Chạm/nhấn để bay — lực bay thấp (dễ điều khiển)</div>
  </div>

<script>
// ---------- Config ----------
const CANVAS_W = 400, CANVAS_H = 600;
const PIPE_W = 80;        // ống rộng
const PIPE_GAP = 150;     // khoảng trống dọc giữa trên/dưới
const PIPE_SPACING = 200; // khoảng cách ngang giữa 2 ống (mức vừa phải)
const PIPE_SPEED = 2;     // tốc độ dịch của ống
const GRAVITY = 0.35;
const LIFT = -5;          // lực nhảy: nhỏ -> bay thấp

// ---------- Elements ----------
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const scoreEl = document.getElementById('score');
const joinModal = document.getElementById('joinModal');
const openTelegram = document.getElementById('openTelegram');
const iJoinedBtn = document.getElementById('iJoined');
const startBtn = document.getElementById('startBtn');
const restartBtn = document.getElementById('restartBtn');

// ---------- State ----------
let bird, pipes, frame, score, running, gameOver, rafId;

// ---------- Helpers ----------
function showJoinIfNeeded(){
  if(localStorage.getItem('joinedTelegram') === 'true'){
    joinModal.style.display = 'none';
    startBtn.style.display = 'block';
  } else {
    joinModal.style.display = 'flex';
    startBtn.style.display = 'none';
  }
}

function setScore(s){
  score = s;
  scoreEl.textContent = 'Điểm: ' + score;
}

// ---------- Game functions ----------
function resetGame(){
  bird = { x: 80, y: CANVAS_H/2 - 15, w: 28, h: 28, vy: 0 };
  pipes = [];
  frame = 0;
  setScore(0);
  running = false;
  gameOver = false;
  cancelAnimationFrame(rafId);
  restartBtn.style.display = 'none';
}

function spawnPipe(){
  // topHeight = height of top pipe (from top)
  const minTop = 40;
  const maxTop = CANVAS_H - PIPE_GAP - 120;
  const topHeight = Math.floor(Math.random() * (maxTop - minTop + 1)) + minTop;
  pipes.push({ x: CANVAS_W, top: topHeight, bottom: CANVAS_H - topHeight - PIPE_GAP, passed:false });
}

function startRun(){
  // Start only if joined
  if(localStorage.getItem('joinedTelegram') !== 'true'){
    // show join modal
    joinModal.style.display = 'flex';
    startBtn.style.display = 'none';
    return;
  }
  // begin
  resetGame();
  running = true;
  gameOver = false;
  startBtn.style.display = 'none';
  // spawn initial pipes a bit apart
  spawnPipe();
  // ensure next spawn occurs after spacing
  frame = 0;
  loop();
}

function endGame(){
  running = false;
  gameOver = true;
  restartBtn.style.display = 'block';
  // ensure RAF cancelled and no multiple loops
  cancelAnimationFrame(rafId);
}

function flap(){
  if(!running || gameOver) return;
  bird.vy = LIFT;
}

// ---------- Update / Draw ----------
function update(){
  frame++;
  // bird physics
  bird.vy += GRAVITY;
  bird.y += bird.vy;
  // limit top (don't go above)
  if(bird.y < 0){ bird.y = 0; bird.vy = 0; }

  // spawn pipes every PIPE_SPACING frames
  if(frame % Math.floor(PIPE_SPACING/ (PIPE_SPEED)) === 0){
    spawnPipe();
  }

  // move pipes
  for(let i = pipes.length -1; i >= 0; i--){
    const p = pipes[i];
    p.x -= PIPE_SPEED;

    // score when pass
    if(!p.passed && p.x + PIPE_W < bird.x){
      p.passed = true;
      setScore(score + 1);
    }

    // remove off-screen
    if(p.x + PIPE_W < 0){
      pipes.splice(i,1);
    }

    // collision
    if(bird.x < p.x + PIPE_W && bird.x + bird.w > p.x){
      if(bird.y < p.top || bird.y + bird.h > CANVAS_H - p.bottom){
        endGame();
        return;
      }
    }
  }

  // ground collision
  if(bird.y + bird.h > CANVAS_H){ endGame(); return; }
}

function draw(){
  // clear
  ctx.clearRect(0,0,CANVAS_W,CANVAS_H);

  // background gradient
  const g = ctx.createLinearGradient(0,0,0,CANVAS_H);
  g.addColorStop(0,'#70c5ce');
  g.addColorStop(1,'#bfeff6');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,CANVAS_W,CANVAS_H);

  // pipes
  ctx.fillStyle = '#228B22';
  for(const p of pipes){
    ctx.fillRect(p.x,0,PIPE_W,p.top);
    ctx.fillRect(p.x,CANVAS_H - p.bottom,PIPE_W,p.bottom);
  }

  // bird
  ctx.fillStyle = '#FFD700';
  ctx.fillRect(bird.x,bird.y,bird.w,bird.h);

  // if not running show hint text
  if(!running && !gameOver){
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.font = '18px Arial';
    ctx.fillText('Nhấn Bắt đầu để chơi (hoặc "Tôi đã tham gia")', 40, CANVAS_H/2 - 20);
  }

  // if gameOver overlay
  if(gameOver){
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
    ctx.fillStyle = '#fff';
    ctx.font = '28px Arial';
    ctx.fillText('Game Over', CANVAS_W/2 - 70, CANVAS_H/2 - 10);
  }
}

function loop(){
  if(!running) return;
  update();
  draw();
  if(gameOver) return;
  rafId = requestAnimationFrame(loop);
}

// ---------- Events ----------
canvas.addEventListener('mousedown', ()=>{ flap(); });
canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); flap(); }, {passive:false});
document.addEventListener('keydown', (e)=>{ if(e.code === 'Space') flap(); });

startBtn.addEventListener('click', ()=> startRun());
restartBtn.addEventListener('click', ()=>{
  restartBtn.style.display = 'none';
  startRun();
});

// join modal handlers
iJoinedBtn.addEventListener('click', ()=>{
  localStorage.setItem('joinedTelegram','true');
  joinModal.style.display = 'none';
  startBtn.style.display = 'block';
});
openTelegram.addEventListener('click', ()=>{
  // set flag before opening to avoid race in some browsers
  // user still needs to press "Tôi đã tham gia"
  // but we mark joined immediately to reduce friction if desired
  // localStorage.setItem('joinedTelegram','true');
  // keep it as "user must confirm"
});

// init
resetGame();
showJoinIfNeeded();
draw();
</script>
</body>
</html>
